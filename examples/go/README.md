# GrpcHub Go Client Examples

This directory contains examples of how to use GrpcHub with Go clients and servers.

## Prerequisites

1. **GrpcHub Server Running**: Make sure the GrpcHub server is running
   ```bash
   cd ../../deploy
   make quick-start-ghcr
   ```

2. **Certificates Generated**: Ensure certificates are available
   ```bash
   cd ../../deploy
   make certs-standalone
   ```

3. **Go Module Dependencies**: This project uses local module dependencies with replace directives
   ```bash
   # From this directory, check the go.mod configuration
   cat go.mod
   
   # The replace directive manages local module dependencies
   # No additional workspace sync needed
   ```

4. **Go Dependencies**: Install required Go modules
   ```bash
   go mod tidy
   ```

## ✅ Module Setup Complete

The Go module is now properly configured with:
- **go.mod** file with replace directive for local development
- **local module dependencies** resolved correctly
- **Go 1.24.2** requirement specified

You should be able to run:
```bash
# From project root
go run ./examples/go server
go run ./examples/go client

# From this directory  
go run main.go server
go run main.go client
```

## Running Examples

### From Project Root (Recommended)
```bash
# Server example
go run ./examples/go server

# Client example (in another terminal)
go run ./examples/go client
```

### From This Directory
```bash
# Server example
go run main.go server

# Client example (in another terminal)
go run main.go client
```

## Go Module Configuration

This project uses local module dependencies with replace directives:

- `grpchub-go/` - Main Go client library
- `examples/go/` - Example implementations

### Module Commands:
```bash
# Update module dependencies
go mod tidy

# Build current module
go build .

# Run tests for current module
go test ./...

# Check module dependencies
go mod graph
```

## Key Concepts

### Component IDs
- Each client and server needs a unique component ID
- Examples: `"echo-server"`, `"echo-client"`
- Used for routing messages through GrpcHub

### Certificate Loading
- Use `client.pem` generated by the certificate process
- The PEM file contains client certificate, private key, and CA certificate
- Function `loadTLSCredentialsFromPEM()` handles the parsing

### Connection Flow
1. Load TLS credentials from PEM file
2. Create `grpchub.GrpcHubClient`
3. Create `grpcx.NewClient` or `grpcx.NewServer`
4. Use standard gRPC patterns

## Real Usage

In production, you would:

1. **Generate Proto Files**: Use `protoc` to generate Go code
   ```bash
   protoc --go_out=. --go-grpc_out=. your_service.proto
   ```

2. **Import Generated Code**: Replace example types with generated ones
   ```go
   import pb "your-proto-package"
   client := pb.NewYourServiceClient(conn)
   ```

3. **Register Services**: Use generated registration functions
   ```go
   pb.RegisterYourServiceServer(grpcSrv, &YourService{})
   ```

## File Structure

```
grpchub/
├── grpchub-go/                # Go client library
│   ├── go.mod                 # Main library module
│   └── ...
├── examples/go/               # This directory
│   ├── go.mod                 # Example module with replace directive
│   ├── main.go                # Example client and server
│   └── README.md              # This file
└── ...
```

## Common Issues

1. **Certificate Path**: Ensure `../../deploy/certs/client.pem` exists
2. **Server Not Running**: Start GrpcHub server first
3. **Port Conflicts**: Default GrpcHub runs on `[::1]:50055`
4. **Component ID Conflicts**: Use unique IDs for each client/server
5. **Module Resolution**: Use `go mod tidy` if you encounter import issues

### ✅ Module Configuration

This project uses **replace directives** for local module dependencies:

**Current working configuration**:
```go
// examples/go/go.mod
module grpchub-example

go 1.24.2

require (
    github.com/lisoboss/grpchub-go v0.1.0
    google.golang.org/protobuf v1.36.6
)

replace github.com/lisoboss/grpchub-go => ../../grpchub-go
```

**Why this works**:
- The `replace` directive tells Go to use local code instead of remote packages
- Go module system resolves dependencies from the local filesystem
- Dependencies are resolved correctly without version conflicts

**Requirements**: Go 1.24.2 or later is required for this project.

## Development Tips

### Working with Modules
```bash
# Update dependencies after pulling changes
go mod tidy

# Check module status
go list -m all

# Build specific module
go build ../../grpchub-go
go build .
```

### IDE Setup
Most Go IDEs automatically detect replace directives and provide proper module resolution and code completion.

## Next Steps

1. Define your gRPC service in `.proto` files
2. Generate Go code with `protoc`
3. Replace example code with your actual service implementation
4. Deploy using the provided Docker configurations
5. Consider creating your own module with replace directives for your application